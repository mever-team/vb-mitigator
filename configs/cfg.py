import sys
from yacs.config import CfgNode as CN
from tools.utils import log_msg


def show_cfg(cfg, logger):
    dump_cfg = CN()
    dump_cfg.EXPERIMENT = cfg.EXPERIMENT
    dump_cfg.MODEL = cfg.MODEL
    dump_cfg.DATASET = cfg.DATASET
    dump_cfg.MITIGATOR = cfg.MITIGATOR
    dump_cfg.SOLVER = cfg.SOLVER
    dump_cfg.LOG = cfg.LOG
    if cfg.MITIGATOR.TYPE in cfg:
        dump_cfg.update({cfg.MITIGATOR.TYPE: cfg.get(cfg.MITIGATOR.TYPE)})
    log_msg("CONFIG:\n{}".format(dump_cfg.dump()), "INFO", logger)


CFG = CN()

# Experiment
CFG.EXPERIMENT = CN()
CFG.EXPERIMENT.PROJECT = "biased_mnist"
CFG.EXPERIMENT.NAME = "dev"
CFG.EXPERIMENT.TAG = "vanilla"
CFG.EXPERIMENT.GPU = "cuda:0"  # or cpu
CFG.EXPERIMENT.SEED = 1
CFG.EXPERIMENT.EVAL = False
CFG.EXPERIMENT.EPOCH_STEPS = sys.maxsize
CFG.EXPERIMENT.PLACEHOLDER_STEPS = sys.maxsize

# Model
CFG.MODEL = CN()
CFG.MODEL.TYPE = "resnet"
CFG.MODEL.PRETRAINED = True
CFG.MODEL.FREEZE_BACKBONE = False
CFG.MODEL.PATH = "best"

# Solver
CFG.SOLVER = CN()
CFG.SOLVER.BATCH_SIZE = 64
CFG.SOLVER.EPOCHS = 240
CFG.SOLVER.LR = 0.05
CFG.SOLVER.WEIGHT_DECAY = 0.0001
CFG.SOLVER.MOMENTUM = 0.9
CFG.SOLVER.TYPE = "SGD"
CFG.SOLVER.CRITERION = "CE"
CFG.SOLVER.SCHEDULER = CN()
CFG.SOLVER.SCHEDULER.TYPE = "MultiStepLR"
CFG.SOLVER.SCHEDULER.LR_DECAY_STAGES = [150, 180, 210]
CFG.SOLVER.SCHEDULER.LR_DECAY_RATE = 0.1

# Log
CFG.LOG = CN()
CFG.LOG.TENSORBOARD_FREQ = 500
CFG.LOG.SAVE_CHECKPOINT_FREQ = 40
CFG.LOG.PREFIX = "./output"
CFG.LOG.WANDB = False
CFG.LOG.TRAIN_PERFORMANCE = False
CFG.LOG.SAVE_CRITERION = "test"

CFG.METRIC = "acc"
CFG.METRIC_TAGS = "wg_ovr_tags"
# Dataset
CFG.DATASET = CN()
CFG.DATASET.TYPE = "cifar100"
CFG.DATASET.NUM_WORKERS = 8
CFG.DATASET.TEST = CN()
CFG.DATASET.TEST.BATCH_SIZE = 64
CFG.DATASET.BIASES = [
    "color",
    "blonde",
    "makeup",
    "race",
    "age",
    "background",
    "foreground",
]


# Dataset specific arguements
CFG.DATASET.BIASED_MNIST = CN()
CFG.DATASET.BIASED_MNIST.RATIO = 0
CFG.DATASET.BIASED_MNIST.CORR = 0.99
CFG.DATASET.BIASED_MNIST.ROOT = "./data/biased_mnist"
CFG.DATASET.BIASED_MNIST.IMAGE_SIZE = 28


# Dataset specific arguements
CFG.DATASET.FB_BIASED_MNIST = CN()
CFG.DATASET.FB_BIASED_MNIST.RATIO = 0
CFG.DATASET.FB_BIASED_MNIST.CORR_BG = 0.9
CFG.DATASET.FB_BIASED_MNIST.CORR_FG = 0.9
CFG.DATASET.FB_BIASED_MNIST.ROOT = "./data/fb_biased_mnist"
CFG.DATASET.FB_BIASED_MNIST.IMAGE_SIZE = 28


# Dataset specific arguements
CFG.DATASET.UTKFACE = CN()
CFG.DATASET.UTKFACE.BIAS = "race"  # or age
CFG.DATASET.UTKFACE.ROOT = "./data/utkface"
CFG.DATASET.UTKFACE.RATIO = 0
CFG.DATASET.UTKFACE.IMAGE_SIZE = 64
CFG.DATASET.UTKFACE.BIAS_ALIGNED = [(1, 1), (0, 0)]

CFG.DATASET.WATERBIRDS = CN()
CFG.DATASET.WATERBIRDS.ROOT = "./data/waterbirds"
CFG.DATASET.WATERBIRDS.IMAGE_SIZE = 224

CFG.DATASET.CELEBA = CN()
CFG.DATASET.CELEBA.ROOT = "./data/celeba"
CFG.DATASET.CELEBA.BIAS = "gender"
CFG.DATASET.CELEBA.TARGET = "blonde"  # or "makeup"
CFG.DATASET.CELEBA.RATIO = 0
CFG.DATASET.CELEBA.IMAGE_SIZE = 224
CFG.DATASET.CELEBA.BIAS_ALIGNED = [(0, 0), (1, 1)]

CFG.DATASET.IMAGENET9 = CN()
CFG.DATASET.IMAGENET9.ROOT_IMAGENET = "/mnt/cephfs/home/gsarridis/datasets/imagenet/"  # you should manually download ImageNet and define the root directory here.
CFG.DATASET.IMAGENET9.ROOT_IMAGENET_BG = "./data/imagenet9"
CFG.DATASET.IMAGENET9.IMAGE_SIZE = 224
CFG.DATASET.IMAGENET9.BIAS = "unknown"
CFG.DATASET.IMAGENET9.BENCHMARK_VAL = "mixed_rand"  # choices: mixed_rand, mixed_next, mixed_same, no_fg, only_bg_b, only_bg_t, only_fg, original
CFG.DATASET.IMAGENET9.BENCHMARK_TEST = "original"  # choices: mixed_rand, mixed_next, mixed_same, no_fg, only_bg_b, only_bg_t, only_fg, original


CFG.DATASET.CIFAR10 = CN()
CFG.DATASET.CIFAR10.ROOT = "./data/cifar10"  # you should manually download ImageNet and define the root directory here.
CFG.DATASET.CIFAR10.IMAGE_SIZE = 32
CFG.DATASET.CIFAR10.BIAS = "clusters"

CFG.DATASET.CIFAR100 = CN()
CFG.DATASET.CIFAR100.ROOT = "./data/cifar100"  # you should manually download ImageNet and define the root directory here.
CFG.DATASET.CIFAR100.IMAGE_SIZE = 32
CFG.DATASET.CIFAR100.BIAS = "clusters"

CFG.DATASET.STANFORD_DOGS = CN()
CFG.DATASET.STANFORD_DOGS.ROOT = "./data/stanford-dogs-dataset"  # you should manually download ImageNet and define the root directory here.
CFG.DATASET.STANFORD_DOGS.IMAGE_SIZE = 224
CFG.DATASET.STANFORD_DOGS.BIAS = "unknown"

CFG.DATASET.URBANCARS = CN()
CFG.DATASET.URBANCARS.ROOT = "./data/urbancars"  # you should manually download ImageNet and define the root directory here.
CFG.DATASET.URBANCARS.IMAGE_SIZE = 224
CFG.DATASET.URBANCARS.BIAS = "bg_cooc_obj"

# MITIGATOR
CFG.MITIGATOR = CN()
CFG.MITIGATOR.TYPE = "erm"  # Vanilla as default
# MAVias CFG
CFG.MITIGATOR.MAVIAS = CN()
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL = CN()
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.TYPE = "ram"
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.IMG_SIZE = 384
CFG.MITIGATOR.MAVIAS.TAGGING_MODEL.BATCH_SIZE = 16
CFG.MITIGATOR.MAVIAS.ENCODER = CN()
CFG.MITIGATOR.MAVIAS.ENCODER.TYPE = "clip"
CFG.MITIGATOR.MAVIAS.ENCODER.SIZE = 768
CFG.MITIGATOR.MAVIAS.LLM = CN()
CFG.MITIGATOR.MAVIAS.LLM.TYPE = "llama3"
CFG.MITIGATOR.MAVIAS.LLM.BATCH_SIZE = 100
CFG.MITIGATOR.MAVIAS.LOSS = CN()
CFG.MITIGATOR.MAVIAS.LOSS.ALPHA = 0.1
CFG.MITIGATOR.MAVIAS.LOSS.LAMBDA = 0.8
CFG.MITIGATOR.MAVIAS.PROJNET = CN()
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM = CN()

CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.LR = 0.001
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.WEIGHT_DECAY = 5e-4
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.MOMENTUM = 0.9
CFG.MITIGATOR.MAVIAS.PROJNET.OPTIM.TYPE = "SGD"

CFG.MITIGATOR.JTT = CN()
CFG.MITIGATOR.JTT.BIAS_DISCOVERY_EPOCHS = 50
CFG.MITIGATOR.JTT.UPWEIGHT = 100
CFG.MITIGATOR.JTT.BCC_PATH = "add the path here"

# FLAC CFG
CFG.MITIGATOR.FLAC = CN()
CFG.MITIGATOR.FLAC.LOSS = CN()
CFG.MITIGATOR.FLAC.LOSS.ALPHA = 110.0
CFG.MITIGATOR.FLAC.LOSS.DELTA = 1.0
CFG.MITIGATOR.FLAC.LOSS.CE_WEIGHT = 1.0
# FLAC-B CFG
CFG.MITIGATOR.FLACB = CN()
CFG.MITIGATOR.FLACB.BCC_PATH = "add the path here"
CFG.MITIGATOR.FLACB.LOSS = CN()
CFG.MITIGATOR.FLACB.LOSS.ALPHA = 110.0
CFG.MITIGATOR.FLACB.LOSS.DELTA = 1.0
CFG.MITIGATOR.FLACB.LOSS.CE_WEIGHT = 1.0

# SOFTCON CFG
CFG.MITIGATOR.SOFTCON = CN()
CFG.MITIGATOR.SOFTCON.BCC_PATH = "add the path here"
CFG.MITIGATOR.SOFTCON.WEIGHT = 1000

# BADD CFG
CFG.MITIGATOR.BADD = CN()
CFG.MITIGATOR.BADD.M = 1.0

# GROUPDRO CFG
CFG.MITIGATOR.GROUPDRO = CN()
CFG.MITIGATOR.GROUPDRO.ROBUST_STEP_SIZE = 0.01

# SPECTRAL DECOUPLE
CFG.MITIGATOR.SD = CN()
CFG.MITIGATOR.SD.COEF = 0.1


# END
CFG.MITIGATOR.END = CN()
CFG.MITIGATOR.END.ALPHA = 1
CFG.MITIGATOR.END.BETA = 1
CFG.MITIGATOR.END.WEIGHT = 1
